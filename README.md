# NokaSmartHome
## Описание модели

Управление системой «Умный дом» осуществляется с помощью специально разработанного приложения языке программирования «Processing» для ПК. USB кабель подключается к ПК и к центральному контроллеру Iskra Neo.
В таблице Г.1 представлен состав основных и вспомогательных технических средств модели.

Таблица Г.1 – Состав основных и вспомогательных технических средств модели
| ОТС | ВТС |
| :---: | :---: |
| ПК | Датчик газа х2 |
| Iskra Neo |	Датчик влажности и температуры х2 |
Arduino nano x2	
Iskra nano x2	
Модуль Wi-Fi (ESP8266) x2	
Модуль Радио (NRF24L01) x2	

На рисунке Г.1 представлена электрическая схема подключения основного, транзитных контроллеров и модулей связи модели.

![image](https://user-images.githubusercontent.com/58054159/178501828-03773e32-536a-47e6-a51f-feeeb783e069.png)

Рисунок Г.1 – Электрическая схема подключения контроллеров и модулей связи

На рисунке Г.2 представлена электрическая схема подключения сенсорных контроллеров, датчиков и модулей связи модели.

![image](https://user-images.githubusercontent.com/58054159/178501879-138c37c8-ddc5-47be-82a3-7405608bf126.png)

Рисунок Г. 2 – Электрическая схема подключения сенсорных контроллеров и датчиков

### Описание стенда (железа)

Натурная модель является аналогом систем, где для управления и взаимодействия устройств используется технологии Wi-Fi или открытый радиоканал, реализуемые соответствующими дополнительными модулями.

Физический уровень модели состоит из датчика дыма, влажности и температуры, модуля беспроводной связи Wi-Fi и радио и пяти контроллеров, которые делятся на 3 класса:
1. основной – контроллер, выступающий связующим звеном между HMI и системой,
2. транзитный – вспомогательный контроллер, взаимодействующий с основным контроллером по протоколу UART и с одним из модулей беспроводной связи,
3. сенсорный контроллер – к нему подключены различные датчики и один вид беспроводной связи для взаимодействия с транзитным.

Сетевой уровень модели представляет собой проводное подключение к управляющему устройству через кабель USB по протоколу UART.

На уровне приложений взаимодействие между системой и пользователем происходит с помощью десктопного приложения, по протоколу UART передаются данные о системе и отображаются на HMI пользователя.

![image](https://user-images.githubusercontent.com/58054159/178502916-45b1dc92-5e53-440d-b012-30dfb1716c59.png)

Внешний вид «Умного дома»

![image](https://user-images.githubusercontent.com/58054159/178502976-b3da9eca-e1ab-4d68-a78f-b2583e1dd1f6.png)

Структурная схема «Умного дома»

![image](https://user-images.githubusercontent.com/58054159/178503026-de2048e6-1751-40cf-808c-9573dd3f9468.png)

HMI «Умного дома»


## Алгоритм работы модели

1. при включении питания транзитные и сенсорные контроллеры начинают инициализацию своих модулей связи,
2. транзитный контроллер с модулем Wi-Fi переводит модуль в режим точки доступа с параметрами: SSID: «Noka_AP», пароль: «132465789», канал: 10, шифрование: WPA2_PSK; и разворачивает TCP – сервер на порту = 333,
3. сенсорный контроллер с модулем Wi-Fi переводит модуль в режим клиента, начинает поиск точки доступа «Noka_AP», подключается к ней и начинает раз в секунду отправлять данные с датчиков,
4. транзитный контроллер с модулем Радио переводит модуль в режим приемника и прослушивает 70 канал, что равен частоте 2470 МГц (2.47 ГГц), при получении данных от передатчика отправляет ответ о принятых данных,
5. сенсорный контроллер с модулем Радио переводит модуль в режим передатчика и на 70 канале (2.47 ГГц) и начинает раз в секунду передавать данные с датчиков, если ответа не пришло от приемника, отправляет данные повторно,
6. при подключении транзитных контроллеров к основному контроллеру через разъем USB (UART), основной контроллер прослушивает каждый порт транзитных контроллеров в течение двух секунд. Самый первый запрос, который отправляет основной контроллер – это запрос готовности транзитного контроллера, в ответ транзитный контроллер отправляет сообщение в виде: «HS1*вид связи*», где HS - название протокола сессии, вид связи – это «R» - радио модуль или W - Wi-Fi модуль, тем самым инициализирует номер порта и какой используется вид связи транзитного модуля. Далее после успешной инициализации посылает запрос на получение данных с сенсорных контроллеров, в ответ транзитные контроллеры посылают данные с датчиков в виде: «DT*значение*H*значение*C*значение*S*значение*», где D - название протокола данных, T - поле телеметрии температуры, H - поле телеметрии влажности, C - поле телеметрии газа, S - поле хэш-суммы отправляемых данных. Хэш-сумма считается операцией XOR названий полей телеметрии и значений этих полей. Основной контроллер при получении данных, считает аналогично Хэш-сумму полученных данных, и, если полученная и посчитанная хэш-сумма равны, отправляет сообщение транзитному контроллеру об отсутствии ошибок при передаче. Если транзитный контроллер не получает подтверждающего сообщения, делает еще 2 попытки отправки данных, после ждет следующего запроса на получение данных. Контроллеры Arduino используют протокол UART для обмена данными с ПК по разъему USB, в случае организации обмена сообщениями между другими контроллерами по этому протоколу необходимо использовать библиотеку Arduino – SoftwareSerial, чтобы на цифровых выходах открыть порт UART. У этой библиотеки есть ограничения, за раз можно прослушивать только один порт,
7. каждый транзитный и сенсорный контроллеры отслеживают и передают ошибки своих модулей связи. Если модуль связи сенсорного контроллера не работает, транзитный контроллер посылает сообщение основному в виде: «EW(R)M», где E - название протокола ошибок, W(R) - наименование модуля связи (Wi-Fi или радио), M - код ошибки модуля связи сенсорного контроллера. Если модуль связи транзитного контроллера не работает, он отправляет сообщение в виде: «EW(R)I», где I - код ошибки модуля связи транзитного контроллера. Ошибки модулей отображаются на HMI пользователя,
8. при успешном получении данных основной контроллер отправляет их на HMI пользователя, где отображаются текущие значения датчиков от конкретного модуля связи.

**!!!**

**Для того, чтобы подключиться к системе, необходимо подключить основной контроллер к ПК через USB, обновить список COM – портов кнопкой на HMI «Refresh COM PORTS», выбрать нужный COM-порт и нажать кнопку на красную кнопку, после подключения она станет зеленой.**

**!!!**

***Примечание*** – При использовании платы Iskra Neo после подключения к ПК необходимо подождать несколько секунд и потом еще раз обновить список COM-портов, это связано с тем, что на этой плате ее Serial-порт доступен сразу, а инициализация внутренней программы занимает некоторое время, из-за чего новый подключенный COM-порт отобразится в списке портов, а подключится к нему не удастся.


![image](https://user-images.githubusercontent.com/58054159/178514781-90206fb9-6d02-43b7-9f1b-ae6668712684.png)

Атака "отказ в обслуживании"
